# Onboarding new client clientside actions.

# Certificate for an OpenLDAP replica  (consumer/client)

export HOSTNAME=`hostname -s`
export CLIENTDIR="$HOSTNAME"-ssl
export CLIENT_PRIVKEY="$HOSTNAME"_slapd_key.pem
export CLIENT_CERT="$HOSTNAME"_slapd_cert.pem

echo Hostname: $HOSTNAME
echo CLIENTDIR $CLIENTDIR
echo CLIENT_PRIVKEY $CLIENT_PRIVKEY
echo CLIENT_CERT $CLIENT_CERT

echo install software ... 15
## Install certtool
sudo apt install -y gnutls-bin sssd-ldap ldap-utils
sudo systemctl restart syslog.service
echo install software ... complete ... 20

echo Create conf-file...
sudo touch /etc/sssd/sssd.conf
sudo chown root:root /etc/sssd/sssd.conf
sudo chmod 666 /etc/sssd/sssd.conf

echo """[sssd]
config_file_version = 2
domains = vertel.se

[domain/vertel.se]
id_provider = ldap
auth_provider = ldap
ldap_uri = ldap://fd.vertel.se
cache_credentials = True
ldap_search_base = ou=vertel,dc=nodomain""" > /etc/sssd/sssd.conf

sudo chmod 0600 /etc/sssd/sssd.conf

sudo systemctl start sssd.service
sudo pam-auth-update --enable mkhomedir


echo Change directory ... 21
cd /etc/ldap/
echo The path ... 23 = `tmp`
echo Do the key ... 24
# Do the key:
sudo certtool --generate-privkey \
--sec-param Medium \
--outfile $CLIENT_PRIVKEY
echo Do the key... done! 29

# Bring the collection of files from the Fusion Directory server to *this* host:
echo COPY FROM FD-SERVER TO LOCAL PATH /TMP
echo scp -rp fd.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp
scp -rp fd.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp

echo Look at TMP! ls /tmp/$CLIENTDIR
echo List of downloading files... 37
ls /tmp/$CLIENTDIR

echo Copy the files...  /etc/ldap... 40
sudo mv /tmp/$CLIENTDIR/*.* /etc/ldap/
echo chmod + chown ... Install certs ... and modify... 42

sudo chmod 0640 /etc/ldap/$CLIENT_PRIVKEY
ls /etc/ldap
sudo cp -r /etc/ldap/mycacert.pem /usr/local/share/ca-certificates/mycacert.crt
sudo update-ca-certificates

echo Change path to /etc/ldap ... 48
cd /etc/ldap

echo Create the file certinfo.ldif ... 68
echo Now is path... 67 = `pwd`

echo touch + a+w certinfo.ldif ... 71  access denied if a+w !!
sudo touch certinfo.ldif
sudo chmod 666 certinfo.ldif

echo Confirm names:
echo CLIENT_CERT: $CLIENT_CERT
echo CLIENT_PRIVKEY: $CLIENT_PRIVKEY

echo """dn: cn=config
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ldap/$CLIENT_CERT
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ldap/$CLIENT_PRIVKEY""" > certinfo.ldif

echo Now is path... 70 = `pwd`
echo Change owner for all files ... 71
sudo chown root:root /etc/ldap/*.*
sudo chmod 0640 /etc/ldap/*.*

cd /etc/ldap/
## Configure the slapd-config database:
# sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif

#### DONE
echo DONE
