# Onboarding new client clientside actions.

# Certificate for an OpenLDAP replica  (consumer/client)

export HOSTNAME=`hostname -s`
export CLIENTDIR="$HOSTNAME"-ssl
export CLIENT_PRIVKEY="$HOSTNAME"_slapd_key.pem
export CLIENT_CERT="$HOSTNAME"_slapd_cert.pem

echo Hostname: $HOSTNAME
echo CLIENTDIR $CLIENTDIR
echo CLIENT_PRIVKEY $CLIENT_PRIVKEY
echo CLIENT_CERT $CLIENT_CERT

echo install software ... 15
## Install certtool
sudo apt install -y gnutls-bin ldap-utils sssd-ldap
sudo systemctl restart syslog.service
echo install software ... complete ... 20

echo Change directory ... 21
cd /etc/ldap/
echo The path ... 23 = `tmp`
echo Do the key ... 24
# Do the key:
sudo certtool --generate-privkey \
--sec-param Medium \
--outfile $CLIENT_PRIVKEY
echo Do the key... done! 29

# Bring the collection of files from the Fusion Directory server to *this* host:
echo COPY FROM FD-SERVER TO LOCAL PATH /TMP
echo scp -rp fd.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp
scp -rp fd.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp

echo Look at TMP! ls /tmp/$CLIENTDIR
echo List of downloading files... 37
ls /tmp/$CLIENTDIR

echo Copy the files...  /etc/ldap... 40
sudo cp -r /tmp/$CLIENTDIR /etc/ldap/
echo chmod + chown ... Install certs ... and modify... 42

sudo chmod 0640 /etc/ldap/$CLIENT_PRIVKEY
ls /etc/ldap
sudo cp -r /etc/ldap/mycacert.pem /usr/local/share/ca-certificates/mycacert.crt
sudo update-ca-certificates

echo Change path to /etc/ldap ... 48
cd /etc/ldap

echo Create the file certinfo.ldif ... 68
echo Now is path... 67 = `pwd`

echo touch + a+w certinfo.ldif ... 71
sudo touch certinfo.ldif
sudo chmod 666 certinfo.ldif

echo Confirm names:
echo CLIENT_CERT: $CLIENT_CERT
echo CLIENT_PRIVKEY: $CLIENT_PRIVKEY

echo """dn: cn=config
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ldap/$CLIENT_CERT
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ldap/$CLIENT_PRIVKEY""" > certinfo.ldif

echo Now is path... 86 = `pwd`
echo Change owner for all files ... 70
# sudo chown root:root .

## Configure the slapd-config database:
sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif

#### DONE
echo DONE
