# Onboarding new client clientside actions.

# Certificate for an OpenLDAP replica  (consumer/client)

export HOSTNAME=`hostname -s`
export CLIENTDIR="$HOSTNAME"-ssl
export CLIENT_PRIVKEY="$HOSTNAME"_slapd_key.pem
export CLIENT_CERT="$HOSTNAME"_slapd_cert.pem

echo Hostname: $HOSTNAME
echo CLIENTDIR $CLIENTDIR
echo CLIENT_PRIVKEY $CLIENT_PRIVKEY
echo CLIENT_CERT $CLIENT_CERT

# NOTE! This is for the single line installer!
## Do the server fiddle while we're at it
#echo Do the server-fiddle while we're at it
#ssh -t fd.vertel.se "sudo create-fd-client-cert $HOSTNAME"

## Install certtool
sudo apt install gnutls-bin
sudo apt install ldap-utils
sudo systemctl restart syslog.service
## Install for SSSD
sudo apt install sssd-ldap ldap-utils

## Do the path:
cd /usr/share/
sudo rm -r $CLIENTDIR
sudo mkdir $CLIENTDIR
echo Do the path...

cd $CLIENTDIR

# Do the key:
sudo certtool --generate-privkey \
--sec-param Medium \
--outfile $CLIENT_PRIVKEY

echo Do the key... done!

#echo Do the remote fiddle...
#ssh fd.vertel.se create-fd-client-cert $HOSTNAME

echo scp -rp fd.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp

# Bring the collection of files from the Fusion Directory server to *this* host:
scp -rp fd.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp
echo Now is path... 49 = `pwd`
echo Look at TMP! ls /tmp/$CLIENTDIR
ls /tmp/$CLIENTDIR

echo Copy the files...
echo make folder ldap in usr/share/
sudo rm -r /usr/share/ldap
sudo mkdir /usr/share/ldap
echo copy data... from /tmp/ ... to /usr/share/ldap + $CLIENTDIR
sudo cp -r /tmp/$CLIENTDIR /usr/share/ldap/
echo The copy is complete!
rm -r /tmp/$CLIENTDIR

echo chown root:root -R /usr/share/ldap/$CLIENTDIR
sudo chown root:root -R /usr/share/ldap/$CLIENTDIR
echo chmod 755 -R /usr/share/ldap/$CLIENTDIR
sudo chmod 755 -R /usr/share/ldap/$CLIENTDIR

echo Install certs ... and modify...
echo cd /usr/share/ldap/$CLIENTDIR
cd /usr/share/ldap/$CLIENTDIR
echo Now is path... 70 = `pwd`
echo Files in path... 71 = `ls | wc -l`

## Install these cert's that was just copied:

## sudo cp deathstar_slapd_cert.pem deathstar_slapd_key.pem /etc/ldap
sudo cp -v $CLIENT_CERT $CLIENT_PRIVKEY /etc/ldap
#sudo cp -v $CLIENT_CERT /etc/ldap/
#sudo cp -v $CLIENT_PRIVKEY /etc/ldap/
echo Files in path... 74 = `ls | wc -l`

## sudo chgrp openldap /etc/ldap/deathstar_slapd_key.pem
## sudo chgrp openldap 
## sudo chmod 0640 /etc/ldap/deathstar_slapd_key.pem
## sudo chmod 0640 /etc/ldap/$CLIENT_PRIVKEY
sudo chmod 760 /etc/ldap/$CLIENT_PRIVKEY
sudo cp -r mycacert.pem /usr/local/share/ca-certificates/mycacert.crt
sudo update-ca-certificates

## Create the file certinfo.ldif ...
echo Create the file certinfo.ldif ...
echo Now is path... 90 = `pwd`

echo touch + a+w certinfo.ldif ... 92
sudo touch certinfo.ldif
sudo chmod a+w certinfo.ldif

echo Confirm names:
echo CLIENT_CERT $CLIENT_CERT
echo CLIENT_PRIVKEY $CLIENT_PRIVKEY

echo """dn: cn=config
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ldap/$CLIENT_CERT
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ldap/$CLIENT_PRIVKEY""" > certinfo.ldif

echo Now is path... 107 = `pwd`
# Change owner for all files
sudo chown root:root .

## Configure the slapd-config database:
sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif

#### DONE
echo DONE
