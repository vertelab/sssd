# Onboarding new client clientside actions.

# Certificate for an OpenLDAP replica  (consumer/client)

export HOSTNAME=`hostname -s`
export CLIENTDIR="$HOSTNAME"-ssl
export CLIENT_PRIVKEY="$HOSTNAME"_slapd_key.pem
export CLIENT_CERT="$HOSTNAME"_slapd_cert.pem

echo Hostname: $HOSTNAME
echo CLIENTDIR $CLIENTDIR
echo CLIENT_PRIVKEY $CLIENT_PRIVKEY
echo CLIENT_CERT $CLIENT_CERT


## Do the server fiddle while we're at it!
echo Do the server fiddle while we can...
ssh fd.vertel.se create-fd-client-cert $HOSTNAME

## Install certtool
sudo apt install gnutls-bin
sudo apt install ldap-utils
sudo systemctl restart syslog.service
## Install for SSSD
sudo apt install sssd-ldap ldap-utils

## Do the path:
cd /usr/share/
sudo rm -r $CLIENTDIR
sudo mkdir $CLIENTDIR
echo Do the path...

cd $CLIENTDIR

# Do the key:
sudo certtool --generate-privkey \
--sec-param Medium \
--outfile $CLIENT_PRIVKEY

echo Do the key... done!

echo Do the remote fiddle...

ssh fd.vertel.se create-fd-client-cert $HOSTNAME

echo vertel@lynx.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp

# Bring the collection of files from the Fusion Directory server to *this* host:
scp -rp vertel@lynx.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp
echo Now is path... 42 = `pwd`

echo Copy the files...
sudo cp -r /tmp/$CLIENTDIR /usr/share/
echo The copy is complete!
rm -r /tmp/$CLIENTDIR

echo chown root:root -R /usr/share/$CLIENTDIR
sudo chown root:root -R /usr/share/$CLIENTDIR
echo chmod 0640 -R /usr/share/$CLIENTDIR
sudo chmod 0640 -R /usr/share/$CLIENTDIR

echo Install certs ... and modify...
echo Now is path... 55 = `pwd`
echo Files in path... 56 = `ls | wc -l`

## Install these cert's that was just copied:

## sudo cp deathstar_slapd_cert.pem deathstar_slapd_key.pem /etc/ldap
sudo cp -v $CLIENT_CERT $CLIENT_PRIVKEY /etc/ldap
#sudo cp -v $CLIENT_CERT /etc/ldap/
#sudo cp -v $CLIENT_PRIVKEY /etc/ldap/
echo Files in path... 64 = `ls | wc -l`

## sudo chgrp openldap /etc/ldap/deathstar_slapd_key.pem
## sudo chgrp openldap 
## sudo chmod 0640 /etc/ldap/deathstar_slapd_key.pem
sudo chmod 0640 /etc/ldap/$CLIENT_PRIVKEY
sudo cp -r mycacert.pem /usr/local/share/ca-certificates/mycacert.crt
sudo update-ca-certificates

## Create the file certinfo.ldif ...
echo Create the file certinfo.ldif ...
echo Now is path... 75 = `pwd`

echo Confirm names:
echo CLIENT_CERT $CLIENT_CERT
echo CLIENT_PRIVKEY $CLIENT_PRIVKEY

echo """dn: cn=config
add: olcTLSCACertificateFile
olcTLSCACertificateFile: /etc/ssl/certs/mycacert.pem
-
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ldap/$CLIENT_CERT
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ldap/$CLIENT_PRIVKEY""" > certinfo.ldif

echo Now is path... 91 = `pwd`
# Change owner for all files
#sudo chown root:root * .

## Configure the slapd-config database:
sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif

#### DONE
echo DONE
