# Onboarding new client serverside actions.
# CA-Variables
CADIR=/usr/share/fd-vertel-se/
SLAPDPRIVKEY=/etc/ldap/fd_vertel_se_slapd_key.pem
CACERT=/etc/ssl/certs/mycacert.pem
CAPRIVKEY=/etc/ssl/private/mycakey.pem


# Certificate for an OpenLDAP replica  (consumer/client)

CLIENT=$1
CLIENTDIR=$CLIENT-ssl
CLIENT_PRIVKEY=$CLIENT_slapd_key.pem
CLIENT_CERT=$CLIENT_slapd_cert.pem
# Check $CLIENT
echo $CLIENT

# Check directory: (exists + rights)
cd $CADIR
[ -d $CLIENTDIR ] && mkdir $CLIENTDIR
cd $CLIENTDIR

# Generate ssl-key
certtool --generate-privkey --sec-param Medium --outfile $CLIENT_PRIVKEY

# Create info file
echo """organization = Vertel AB
cn = $CLIENT.vertel.se
tls_www_server
encryption_key
signing_key
expiration_days = 3650
""" > $CLIENT.info

# Change owner for all files
sudo chown root:root .*

# Create the consumer/client certificate
sudo certtool --generate-certificate \
--load-privkey $CLIENT_PRIVKEY \
--load-ca-certificate $CACERT \
--load-ca-privkey $CAPRIVKEY \
--template $CLIENT.info \
--outfile $CLIENT_CERT

# Get a copy of the CA certificate:
cp $CACERT .

#### DONE
echo DONE
