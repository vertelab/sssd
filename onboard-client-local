# Onboarding new client clientside actions.

# Certificate for an OpenLDAP replica  (consumer/client)

export HOSTNAME=`hostname -s`
export CLIENTDIR="$HOSTNAME"-ssl
export CLIENT_PRIVKEY="$HOSTNAME"_slapd_key.pem
export CLIENT_CERT="$HOSTNAME"_slapd_cert.pem

echo Hostname: $HOSTNAME
echo CLIENTDIR $CLIENTDIR
echo CLIENT_PRIVKEY $CLIENT_PRIVKEY
echo CLIENT_CERT $CLIENT_CERT

# NOTE! This is for the single line installer!
## Do the server fiddle while we're at it
#echo Do the server-fiddle while we're at it
#ssh -t fd.vertel.se "sudo create-fd-client-cert $HOSTNAME"

echo install software ... 20
## Install certtool
sudo apt update
sudo apt install gnutls-bin
sudo apt install ldap-utils
sudo systemctl restart syslog.service
## Install for SSSD
sudo apt install sssd-ldap ldap-utils
echo install software ... complete ... 28

echo Change directory ... 30
cd /etc/ldap/
echo The path ... 32 = `tmp`
echo Do the key ... 33
# Do the key:
sudo certtool --generate-privkey \
--sec-param Medium \
--outfile $CLIENT_PRIVKEY
echo Do the key... done! 38

# echo Do the remote fiddle...
# ssh fd.vertel.se create-fd-client-cert $HOSTNAME

echo Bring it on!
echo scp -rp fd.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp

# Bring the collection of files from the Fusion Directory server to *this* host:
scp -rp fd.vertel.se:/usr/share/fd-vertel-se/$CLIENTDIR /tmp
echo COPY TO LOCAL PATH /TMP

echo Now is path... 48 = `pwd`
echo Look at TMP! ls /tmp/$CLIENTDIR
echo List of downloading files... 50
ls /tmp/$CLIENTDIR

echo Copy the files...  /etc/ldap... 56
sudo cp -r /tmp/$CLIENTDIR /etc/ldap/
echo Install certs ... and modify... 55

## sudo chmod 0640 /etc/ldap/deathstar_slapd_key.pem
## sudo chmod 0640 /etc/ldap/$CLIENT_PRIVKEY
sudo chmod 0640 /etc/ldap/$CLIENT_PRIVKEY
sudo cp -r /etc/ldap/mycacert.pem /usr/local/share/ca-certificates/mycacert.crt
sudo update-ca-certificates

echo Change path to /etc/ldap ... 65
cd /etc/ldap

echo Create the file certinfo.ldif ... 68
echo Now is path... 67 = `pwd`

echo touch + a+w certinfo.ldif ... 71
sudo touch certinfo.ldif
sudo chmod 0640 certinfo.ldif

echo Confirm names:
echo CLIENT_CERT $CLIENT_CERT
echo CLIENT_PRIVKEY $CLIENT_PRIVKEY

echo """dn: cn=config
add: olcTLSCertificateFile
olcTLSCertificateFile: /etc/ldap/$CLIENT_CERT
-
add: olcTLSCertificateKeyFile
olcTLSCertificateKeyFile: /etc/ldap/$CLIENT_PRIVKEY""" > certinfo.ldif

echo Now is path... 86 = `pwd`
Change owner for all files
# sudo chown root:root .

## Configure the slapd-config database:
sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f certinfo.ldif

#### DONE
echo DONE
